name: "üõ°Ô∏è Advanced DevSecOps Pipeline - Ligas Mayores"

on:
  # Permite ejecuci√≥n manual desde la pesta√±a Actions
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'Profundidad del escaneo de secretos'
        required: true
        default: '0'
        type: string
  # Permite que otros repositorios llamen a este pipeline
  workflow_call:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1'

# Permisos granulares para m√°xima seguridad (Principio de Menor Privilegio)
permissions:
  contents: read
  security-events: write # Para subir reportes a la pesta√±a Security
  id-token: write

jobs:
  # --- FASE 1: SECRETOS (BLOQUEO INMEDIATO) ---
  secrets-audit:
    name: "üîë Gitleaks Secret Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event.inputs.scan_depth || 0 }}
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Si encuentra una llave de AWS en el script, el pipeline muere aqu√≠.
        with:
          fail-on-vulnerabilities: true 

  # --- FASE 2: AN√ÅLISIS DE C√ìDIGO (SAST) ---
  sast-audit:
    name: "üíª Semgrep AppSec Scan"
    runs-on: ubuntu-latest
    needs: secrets-audit
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          # Detectar√° la inyecci√≥n en el 'sed' del api-gateway
          config: >-
            p/default
            p/security-audit
            p/secrets
            p/owasp-top-ten
          generateSarif: "1"
      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()

  # --- FASE 3: INFRAESTRUCTURA Y DOCKER (IaC) ---
  infrastructure-audit:
    name: "üèóÔ∏è Checkov & Trivy IaC"
    runs-on: ubuntu-latest
    needs: sast-audit
    steps:
      - uses: actions/checkout@v4
      - name: Checkov Scan (EKS & API Gateway)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all 
          soft_fail: false # Hard stop si la nube est√° mal configurada
      
      - name: Trivy FS & Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config,fs'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  # --- FASE 4: CADENA DE SUMINISTRO (PUNTUACI√ìN CISO) ---
  supply-chain:
    name: "üîó OpenSSF Scorecard"
    runs-on: ubuntu-latest
    needs: infrastructure-audit
    steps:
      - uses: actions/checkout@v4
      - name: "Run Analysis"
        uses: ossf/scorecard-action@v2.3.1
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

  # --- FASE 5: DEPENDENCIAS Y BINARIOS (Snyk) ---
  dependency-audit:
    name: "üß™ Snyk & Compliance"
    runs-on: ubuntu-latest
    needs: supply-chain
    # Solo corre si tenemos el token, as√≠ evitamos que el job falle por falta de config
    if: "${{ secrets.SNYK_TOKEN != '' }}"
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk Test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
