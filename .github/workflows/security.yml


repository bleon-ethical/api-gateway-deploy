name: "SecVu"

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1' # Escaneo profundo todos los lunes a medianoche

jobs:
  # --- FASE 1: SECRETOS Y CREDENCIALES ---
  secrets-audit:
    name: "üîë Gitleaks Secret Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para escanear todo el historial de Git
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- FASE 2: AN√ÅLISIS EST√ÅTICO DE C√ìDIGO (SAST) ---
  sast-audit:
    name: "üíª Semgrep AppSec Scan"
    runs-on: ubuntu-latest
    needs: secrets-audit
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          # p/security-audit y p/secrets son reglas de nivel experto
          config: >-
            p/default
            p/security-audit
            p/secrets
            p/ci
          generateSarif: "1"
      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
        if: always()

  # --- FASE 3: SEGURIDAD DE INFRAESTRUCTURA (IaC) ---
  infrastructure-audit:
    name: "üèóÔ∏è Checkov IaC Hardening"
    runs-on: ubuntu-latest
    needs: sast-audit
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all # Escanea Docker, Kubernetes, Terraform y Shell
          quiet: false
          soft_fail: false # Detiene el pipeline si hay errores cr√≠ticos
          download_external_modules: true

  # --- FASE 4: VULNERABILIDADES EN CONTENEDORES (SCA) ---
  container-audit:
    name: "üì¶ Trivy Container Security"
    runs-on: ubuntu-latest
    needs: infrastructure-audit
    steps:
      - uses: actions/checkout@v4
      - name: Scan Dockerfile and Filesystem
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs,config'
          format: 'table'
          exit-code: '1' # Falla si hay vulnerabilidades cr√≠ticas
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'

  # --- FASE 5: SEGURIDAD DE LA CADENA DE SUMINISTRO ---
  supply-chain-audit:
    name: "üîó StepSecurity & OpenSSF"
    runs-on: ubuntu-latest
    needs: container-audit
    steps:
      - uses: actions/checkout@v4
      - name: OpenSSF Scorecard Action
        uses: ossf/scorecard-action@v2.0.6
        with:
          results_file: results.sarif
          results_format: sarif
          # Analiza la salud y seguridad del mantenimiento del repo
          publish_results: true

  # --- FASE 6: AUDITOR√çA DE DEPENDENCIAS (Snyk) ---
  dependency-audit:
    name: "üß™ Snyk Dependency Scan"
    runs-on: ubuntu-latest
    needs: supply-chain-audit
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master # Ajustar seg√∫n el lenguaje (python, java, go)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor # Env√≠a los reportes al dashboard de Snyk
